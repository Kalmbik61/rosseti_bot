#!/bin/bash

# Entrypoint script –¥–ª—è Telegram –±–æ—Ç–∞ –ø–∞—Ä—Å–µ—Ä–∞ –†–æ—Å—Å–µ—Ç–∏

set -e

echo "üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø–∞—Ä—Å–µ—Ä–∞ –†–æ—Å—Å–µ—Ç–∏..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -z "$TELEGRAM_BOT_TOKEN" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è TELEGRAM_BOT_TOKEN"
    echo "üí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã —Å–æ–∑–¥–∞–ª–∏ .env —Ñ–∞–π–ª —Å —Ç–æ–∫–µ–Ω–æ–º –±–æ—Ç–∞"
    exit 1
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
mkdir -p /app/data /app/logs /app/reports

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
if [ ! -w /app/data ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ—Ç –ø—Ä–∞–≤ –∑–∞–ø–∏—Å–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é /app/data"
    exit 1
fi

if [ ! -w /app/logs ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ—Ç –ø—Ä–∞–≤ –∑–∞–ø–∏—Å–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é /app/logs"
    exit 1
fi

if [ ! -w /app/reports ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ—Ç –ø—Ä–∞–≤ –∑–∞–ø–∏—Å–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é /app/reports"
    exit 1
fi

echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Playwright –±—Ä–∞—É–∑–µ—Ä–æ–≤ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
CHROMIUM_PATH="/home/botuser/.cache/ms-playwright/chromium_headless_shell"
if [ ! -d "$CHROMIUM_PATH" ] || [ -z "$(ls -A $CHROMIUM_PATH 2>/dev/null)" ]; then
    echo "üåê –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Playwright –±—Ä–∞—É–∑–µ—Ä–æ–≤..."
    npx playwright install chromium --with-deps
    echo "‚úÖ Playwright –±—Ä–∞—É–∑–µ—Ä—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
else
    echo "‚úÖ Playwright –±—Ä–∞—É–∑–µ—Ä—ã —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
fi

# –ó–∞–ø—É—Å–∫ –Ω—É–∂–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã
case "$1" in
    "bot")
        echo "ü§ñ –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞..."
        exec node public/bot.js
        ;;
    "api")
        echo "üîß –ó–∞–ø—É—Å–∫ API –¥–µ–º–æ..."
        exec node public/index.js
        ;;
    "test")
        echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
        exec node public/tests/test.js
        ;;
    "bash")
        echo "üêö –ó–∞–ø—É—Å–∫ bash —Å–µ—Å—Å–∏–∏..."
        exec /bin/bash
        ;;
    *)
        echo "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: $1"
        echo "üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
        echo "  bot   - –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"
        echo "  api   - –ó–∞–ø—É—Å–∫ API –¥–µ–º–æ"
        echo "  test  - –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤"
        echo "  bash  - –ó–∞–ø—É—Å–∫ bash —Å–µ—Å—Å–∏–∏"
        echo ""
        echo "ü§ñ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é..."
        exec node public/bot.js
        ;;
esac
